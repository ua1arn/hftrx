// https://dogbolt.org/

// H3, A64 video out work, no EDID read

#include "hardware.h"
#include "formats.h"	// for PRINTF prints

#if WITHLTDCHW && WITHHDMITVHW && 1

/* This file was generated by the Hex-Rays decompiler version 8.4.0.240320.
 Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

 Detected compiler: GNU C++
 */

//#include <defs.h>
struct video_para;
struct audio_para;
struct hdmi_bsp_func;

enum audio_type
{
	PCM = 1, AC3, MPEG1, MP3, MPEG2, AAC, DTS, ATRAC, OBA, DDP, DTS_HD, MAT, DST, WMA_PRO,
};

enum color_space
{
	BT601 = 1, BT709, EXT_CSC,
};

struct para_tab
{
	unsigned int para [19];
};

struct pcm_sf
{
	unsigned int sf;
	unsigned char cs_sf;
};

static unsigned video_csc;
static unsigned video_is_yuv;
static unsigned video_is_hcts;
static unsigned video_is_hdmi = 1;
static unsigned video_clk_div = 1;

static unsigned audio_ca;	// ????????
static unsigned audio_ch_num = 2;
static unsigned audio_sample_rate = 48000;
static unsigned audio_sample_bit = 24;
static unsigned audio_type = PCM;

//-------------------------------------------------------------------------
// Function declarations

void hdmi_udelay(unsigned int us);
void hdmi_mdelay(unsigned int ms);
void hdmi_write(unsigned int addr, uint8_t data);
void hdmi_writel(unsigned int addr, unsigned int data);
uint8_t hdmi_read(unsigned int addr);
unsigned int hdmi_readl(unsigned int addr);
unsigned int get_vid(unsigned int id);
void bsp_hdmi_inner_init(void); // idb
void hdmi_phy_init(void); // idb
//int bsp_hdmi_set_func(hdmi_bsp_func *func);
int bsp_hdmi_set_bias_source(unsigned int src);
void bsp_hdmi_set_version(unsigned int version);
void bsp_hdmi_set_addr(unsigned int base_addr);
void bsp_hdmi_init(void); // idb
void bsp_hdmi_set_video_en(uint8_t enable);
int bsp_hdmi_video(unsigned int vic);
int bsp_hdmi_audio(unsigned int vic);
int bsp_hdmi_ddc_read(char cmd, char pointer, char offset, int nbyte, char *pbuf);
int bsp_hdmi_get_hpd(void);
void bsp_hdmi_standby(void); // idb
void bsp_hdmi_hrst(void); // idb
int bsp_hdmi_hdcp_err_check(void); // idb
int bsp_hdmi_cec_get_simple_msg(uint8_t *msg);
int bsp_hdmi_cec_send(char *buf, uint8_t bytes);
void bsp_hdmi_cec_free_time_set(uint8_t value);
int bsp_hdmi_cec_sta_check(void); // idb

//-------------------------------------------------------------------------
// Data declarations

//hdmi_bsp_func hdmi_func; // idb
unsigned int hdmi_base_addr; // idb
unsigned int tmp_rcal_100; // idb
unsigned int tmp_rcal_200; // idb
unsigned int rcal_flag; // idb
unsigned int bias_source; // idb
unsigned int hdmi_version; // idb
//struct video_para glb_video; // idb
const struct para_tab ptbl [19] =
{
{
{ 6u, 1u, 1u, 1u, 5u, 3u, 0u, 1u, 4u, 0u, 0u, 160u, 20u, 38u, 124u, 240u, 22u, 0u, 0u } },
{
{ 21u, 11u, 1u, 1u, 5u, 3u, 1u, 1u, 2u, 0u, 0u, 160u, 32u, 24u, 126u, 32u, 24u, 0u, 0u } },
{
{ 2u, 11u, 0u, 0u, 2u, 6u, 1u, 0u, 9u, 0u, 0u, 208u, 138u, 16u, 62u, 224u, 45u, 0u, 0u } },
{
{ 17u, 11u, 0u, 0u, 2u, 5u, 2u, 0u, 5u, 0u, 0u, 208u, 144u, 12u, 64u, 64u, 49u, 0u, 0u } },
{
{ 19u, 4u, 0u, 96u, 5u, 5u, 2u, 2u, 5u, 1u, 0u, 0u, 188u, 184u, 40u, 208u, 30u, 1u, 1u } },
{
{ 4u, 4u, 0u, 96u, 5u, 5u, 2u, 1u, 5u, 0u, 0u, 0u, 114u, 110u, 40u, 208u, 30u, 1u, 1u } },
{
{ 20u, 4u, 0u, 97u, 7u, 5u, 4u, 2u, 2u, 2u, 0u, 128u, 208u, 16u, 44u, 56u, 22u, 1u, 1u } },
{
{ 5u, 4u, 0u, 97u, 7u, 5u, 4u, 1u, 2u, 0u, 0u, 128u, 24u, 88u, 44u, 56u, 22u, 1u, 1u } },
{
{ 31u, 2u, 0u, 96u, 7u, 5u, 4u, 2u, 4u, 2u, 0u, 128u, 208u, 16u, 44u, 56u, 45u, 1u, 1u } },
{
{ 16u, 2u, 0u, 96u, 7u, 5u, 4u, 1u, 4u, 0u, 0u, 128u, 24u, 88u, 44u, 56u, 45u, 1u, 1u } },
{
{ 32u, 4u, 0u, 96u, 7u, 5u, 4u, 3u, 4u, 2u, 0u, 128u, 62u, 126u, 44u, 56u, 45u, 1u, 1u } },
{
{ 33u, 4u, 0u, 0u, 7u, 5u, 4u, 2u, 4u, 2u, 0u, 128u, 208u, 16u, 44u, 56u, 45u, 1u, 1u } },
{
{ 34u, 4u, 0u, 0u, 7u, 5u, 4u, 1u, 4u, 0u, 0u, 128u, 24u, 88u, 44u, 56u, 45u, 1u, 1u } },
{
{ 160u, 2u, 0u, 96u, 7u, 5u, 8u, 3u, 4u, 2u, 0u, 128u, 62u, 126u, 44u, 157u, 45u, 1u, 1u } },
{
{ 147u, 2u, 0u, 96u, 5u, 5u, 5u, 2u, 5u, 1u, 0u, 0u, 188u, 184u, 40u, 190u, 30u, 1u, 1u } },
{
{ 132u, 2u, 0u, 96u, 5u, 5u, 5u, 1u, 5u, 0u, 0u, 0u, 114u, 110u, 40u, 160u, 30u, 1u, 1u } },
{
{ 257u, 1u, 0u, 96u, 15u, 10u, 8u, 2u, 8u, 0u, 0u, 0u, 48u, 176u, 88u, 112u, 90u, 1u, 1u } },
{
{ 258u, 1u, 0u, 96u, 15u, 10u, 8u, 5u, 8u, 4u, 0u, 0u, 160u, 32u, 88u, 112u, 90u, 1u, 1u } },
{
{ 259u, 1u, 0u, 96u, 15u, 10u, 8u, 6u, 8u, 4u, 0u, 0u, 124u, 252u, 88u, 112u, 90u, 1u, 1u } } }; // idb
const uint8_t ca_table [64] =
{ 0u, 17u, 1u, 19u, 2u, 49u, 3u, 51u, 4u, 21u, 5u, 23u, 6u, 53u, 7u, 55u, 8u, 85u, 9u, 87u, 10u, 117u, 11u, 119u, 12u, 93u, 13u, 95u, 14u, 125u, 15u, 127u, 16u, 221u, 17u, 223u, 18u, 253u, 19u, 255u, 20u, 153u, 21u, 155u, 22u, 185u, 23u, 187u, 24u, 157u,
		25u, 159u, 26u, 189u, 27u, 191u, 28u, 221u, 29u, 223u, 30u, 253u, 31u, 255u }; // idb
const struct pcm_sf sf [10] =
{
{ 22050u, 4u },
{ 44100u, 0u },
{ 88200u, 8u },
{ 176400u, 12u },
{ 24000u, 6u },
{ 48000u, 2u },
{ 96000u, 10u },
{ 192000u, 14u },
{ 32000u, 3u },
{ 768000u, 9u } }; // idb
const unsigned int n_table [21] =
{ 32000u, 3072u, 4096u, 44100u, 4704u, 6272u, 88200u, 9408u, 12544u, 176400u, 18816u, 25088u, 48000u, 5120u, 6144u, 96000u, 10240u, 12288u, 192000u, 20480u, 24576u }; // idb

//----- (00000000) --------------------------------------------------------
void hdmi_udelay(unsigned int us)
{
	local_delay_us(us);
}

//----- (00000044) --------------------------------------------------------
void hdmi_mdelay(unsigned int ms)
{
	local_delay_ms(ms);
}

//----- (00000088) --------------------------------------------------------
void hdmi_write(unsigned int addr, uint8_t data)
{
	__DSB();
	* (volatile uint8_t*) (addr + hdmi_base_addr) = data;
}

//----- (000000A0) --------------------------------------------------------
void hdmi_writel(unsigned int addr, unsigned int data)
{
	__DSB();
	* (volatile uint32_t*) (addr + hdmi_base_addr) = data;
}

//----- (000000B8) --------------------------------------------------------
uint8_t hdmi_read(unsigned int addr)
{
	return * (volatile uint8_t*) (addr + hdmi_base_addr);
}

//----- (000000CC) --------------------------------------------------------
unsigned int hdmi_readl(unsigned int addr)
{
	return * (volatile uint32_t *) (addr + hdmi_base_addr);
}

//----- (000000E0) --------------------------------------------------------
unsigned int get_vid(unsigned int id)
{
	int v1; // r2
	unsigned int v2; // r3

	v1 = 0;
	v2 = 0;
	while (id != ptbl [v1].para [0])
	{
		++ v2;
		++ v1;
		if (v2 == 19)
			return - 1;
	}
	return v2;
}

//----- (00000118) --------------------------------------------------------
void bsp_hdmi_inner_init()
{
	hdmi_read(0);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	hdmi_write(0x8080u, 0);
	hdmi_udelay(1u);
	hdmi_write(0xF01Fu, 0);
	hdmi_write(0x8403u, 0xFFu);
	hdmi_write(0x904Cu, 0xFFu);
	hdmi_write(0x904Eu, 0xFFu);
	hdmi_write(0xD04Cu, 0xFFu);
	hdmi_write(0x8250u, 0xFFu);
	hdmi_write(0x8A50u, 0xFFu);
	hdmi_write(0x8272u, 0xFFu);
	hdmi_write(0x40C0u, 0xFFu);
	hdmi_write(0x86F0u, 0xFFu);
	hdmi_write(0xEE3u, 0xFFu);
	hdmi_write(0x8EE2u, 0xFFu);
	hdmi_write(0xA049u, 0xF0u);
	hdmi_write(0xB045u, 0x1Eu);
	hdmi_write(0xC1u, 0);
	hdmi_write(0xC1u, 3u);
	hdmi_write(0xC0u, 0);
	hdmi_write(0x40C1u, 0x10u);
	hdmi_write(0x81u, 0xFDu);
	hdmi_write(0x81u, 0);
	hdmi_write(0x81u, 0xDDu);
	hdmi_write(0x10u, 0xFFu);
	hdmi_write(0x11u, 0xFFu);
	hdmi_write(0x8010u, 0xFFu);
	hdmi_write(0x8011u, 0xFFu);
	hdmi_write(0x13u, 0xFFu);
	hdmi_write(0x8012u, 0xFFu);
	hdmi_write(0x8013u, 0xFFu);
}

//----- (000002CC) --------------------------------------------------------
void hdmi_phy_init()
{
	int v0; // r4
	unsigned int v8; // r0
	unsigned int v9; // r0
	unsigned int v10; // r0
	unsigned int v11; // r5
	unsigned int v12; // r0
	unsigned int v13; // r0
	unsigned int v14; // r0

	v0 = 10;
	hdmi_writel(0x10020u, 0);
	hdmi_writel(0x10020u, 1u);
	hdmi_udelay(5u);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 0x10000);	// 	TDNSCLKEB=N
	ASSERT(hdmi_readl(0x10020u) & 0x10000);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 2);	// ENVBS
	ASSERT(hdmi_readl(0x10020u) & 2);
	hdmi_udelay(0xAu);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 4);	// LDOEN
	ASSERT(hdmi_readl(0x10020u) & 4);
	hdmi_udelay(5u);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 8);	// CKEN
	ASSERT(hdmi_readl(0x10020u) & 8);
	hdmi_udelay(0x28u);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 0x80000);
	ASSERT(hdmi_readl(0x10020u) & 0x80000);
	hdmi_udelay(0x64u);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 0x40000);
	ASSERT(hdmi_readl(0x10020u) & 0x40000);
	hdmi_writel(0x10020u, hdmi_readl(0x10020u) | 0x70);
	do
	{
		if ((hdmi_readl(0x10038u) & 0x80) != 0)
			break;
		hdmi_udelay(0xC8u);
		-- v0;
	} while (v0);
	PRINTF("HDMI PHY PLL status: %08X\n", (unsigned) hdmi_readl(0x10038u));
	v8 = hdmi_readl(0x10020u);
	hdmi_writel(0x10020u, v8 | 0xF00);
	v9 = hdmi_readl(0x10020u);
	hdmi_writel(0x10020u, v9 | 0x80);
	hdmi_writel(0x1002Cu, 0x3DDC5040u);
	hdmi_writel(0x10030u, 0x80084343);
	hdmi_mdelay(0xAu);
	hdmi_writel(0x10034u, 1u);
	v10 = hdmi_readl(0x1002Cu);
	hdmi_writel(0x1002Cu, v10 | 0x2000000);
	hdmi_mdelay(0x64u);
	v11 = hdmi_readl(0x10038u);
	tmp_rcal_100 = (uint8_t) (v11 & 0x3F) >> 1;
	tmp_rcal_200 = (uint8_t) (v11 & 0x3F) >> 2;
	rcal_flag = 1;
	v12 = hdmi_readl(0x1002Cu);
	hdmi_writel(0x1002Cu, v12 | 0xC0000000);
	v13 = hdmi_readl(0x1002Cu);
	hdmi_writel(0x1002Cu, ((v11 >> 11) & 0x3F) | v13);
	hdmi_writel(0x10020u, 0x1FF0F7Fu);
	hdmi_writel(0x10024u, 0x80639000);
	hdmi_writel(0x10028u, 0xF81C405u);
	if (bias_source)
	{
		v14 = hdmi_readl(0x10004u);
		hdmi_writel(0x10004u, v14 | 0x20000);
	}
	//printhex32(hdmi_base_addr + 0x10000, hdmi_base_addr + 0x10000, 256);
}
//
////----- (00000508) --------------------------------------------------------
//int bsp_hdmi_set_func(hdmi_bsp_func *func)
//{
//  int v1; // zf
//  void (*delay_ms)(unsigned int); // r2
//  int result; // r0
//
//  v1 = func == 0;
//  delay_ms = 0;
//  hdmi_func.delay_us = 0;
//  hdmi_func.delay_ms = 0;
//  if ( func )
//  {
//    hdmi_func.delay_us = func->delay_us;
//    delay_ms = func->delay_ms;
//  }
//  result = 0;
//  if ( !v1 )
//    hdmi_func.delay_ms = delay_ms;
//  return result;
//}

//----- (00000538) --------------------------------------------------------
int bsp_hdmi_set_bias_source(unsigned int src)
{
	bias_source = src;
	return 0;
}

//----- (0000054C) --------------------------------------------------------
void bsp_hdmi_set_version(unsigned int version)
{
	hdmi_version = version;
}

//----- (0000055C) --------------------------------------------------------
void bsp_hdmi_set_addr(unsigned int base_addr)
{
	hdmi_base_addr = base_addr;
	rcal_flag = 0;
}

//----- (00000574) --------------------------------------------------------
void bsp_hdmi_init(void)
{
	hdmi_phy_init();
	bsp_hdmi_inner_init();
}

//----- (00000584) --------------------------------------------------------
void bsp_hdmi_set_video_en(uint8_t enable)
{
	unsigned int v1; // r1

	if (enable)
		v1 = hdmi_readl(0x10020u) | 0xF000;
	else
		v1 = hdmi_readl(0x10020u) & 0xFFFF0FFF;
	hdmi_writel(0x10020u, v1);
}

//----- (000005BC) --------------------------------------------------------
int bsp_hdmi_video(unsigned int vic)
{
	unsigned int vid; // r0
	unsigned int v4; // r6
	unsigned int v5; // r4
	unsigned int v6; // r0
	unsigned int v7; // r1
	unsigned int v8; // r0
	unsigned int v9; // r4
	unsigned int v10; // r0
	unsigned int v11; // r4
	unsigned int v12; // r1
	unsigned int v13; // r1
	unsigned int v14; // r0
	unsigned int v15; // r4
	unsigned int v16; // r0
	unsigned int v17; // r0
	unsigned int v18; // r0
	unsigned int v19; // r4
	unsigned int v20; // r0
	unsigned int v21; // r0
	unsigned int v22; // r0
	unsigned int v23; // r4
	unsigned int v24; // r0
	unsigned int v25; // r0
	const struct para_tab *v26; // r4
	unsigned int v27; // r10
	uint8_t v28; // r1
	unsigned int v29; // r4
	uint8_t v30; // r1
	uint8_t v31; // r1
	unsigned int v32; // r4
	uint8_t v33; // r1
	uint8_t v34; // r1
	uint8_t v35; // r0
	uint8_t v36; // r1
	enum color_space csc; // r1
	unsigned int v38; // r3
	uint8_t v39; // r1
	char v40; // r1
	char v41; // r1
	uint8_t v42; // r1
	unsigned int v43; // r1
	uint8_t v44; // r1
	uint8_t v45; // r1
	uint8_t v46; // r1
	int v47; // r0
	uint8_t v48; // r1
	int result; // r0

	vid = get_vid(vic);
	//glb_video.vic = vic;
	v4 = vid;
	if (vic <= 0x15 && ((1 << vic) & 0x220044) != 0)
		video_csc = BT601;
	else
		video_csc = BT709;
	if (! rcal_flag)
		hdmi_phy_init();
	v5 = get_vid(vic);
	v6 = hdmi_readl(0x10020u);
	hdmi_writel(0x10020u, v6 & 0xFFFF0FFF);
	switch (ptbl [v5].para [1])
	{
	case 1u:
		if (hdmi_version)
			v7 = 886857664;
		else
			v7 = 903634880;
		hdmi_writel(0x1002Cu, v7);
		hdmi_writel(0x10030u, 0x800863C0);
		hdmi_mdelay(0xAu);
		hdmi_writel(0x10034u, 1u);
		v8 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v8 | 0x2000000);
		hdmi_mdelay(0xC8u);
		v9 = hdmi_readl(0x10038u);
		v10 = hdmi_readl(0x1002Cu);
		v11 = (v9 >> 11) & 0x3F;
		hdmi_writel(0x1002Cu, v10 | 0xC0000000);
		if (v11 > 0x3C)
			v12 = hdmi_readl(0x1002Cu) | 0x3F;
		else
			v12 = hdmi_readl(0x1002Cu) | (v11 + 2);
		hdmi_writel(0x1002Cu, v12);
		hdmi_mdelay(0x64u);
		hdmi_writel(0x10020u, 0x1FFFF7Fu);
		hdmi_writel(0x10024u, 0x8063B000);
		v13 = 260196021;
		goto LABEL_18;
	case 2u:
		hdmi_writel(0x1002Cu, 0x3DDC5040u);
		hdmi_writel(0x10030u, 0x80084381);
		hdmi_mdelay(0xAu);
		hdmi_writel(0x10034u, 1u);
		v14 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v14 | 0x2000000);
		hdmi_mdelay(0x64u);
		v15 = hdmi_readl(0x10038u);
		v16 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v16 | 0xC0000000);
		v17 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, ((v15 >> 11) & 0x3F) | v17);
		hdmi_writel(0x10020u, 0x1FFFF7Fu);
		hdmi_writel(0x10024u, 0x8063A800);
		v13 = 260162693;
		goto LABEL_18;
	case 4u:
		hdmi_writel(0x1002Cu, 0x3DDC5040u);
		hdmi_writel(0x10030u, 0x80084343);
		hdmi_mdelay(0xAu);
		hdmi_writel(0x10034u, 1u);
		v18 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v18 | 0x2000000);
		hdmi_mdelay(0x64u);
		v19 = hdmi_readl(0x10038u);
		v20 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v20 | 0xC0000000);
		v21 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, ((v19 >> 11) & 0x3F) | v21);
		hdmi_writel(0x10020u, 0x11FFFF7Fu);
		hdmi_writel(0x10024u, tmp_rcal_200 | 0x80623000);
		v13 = 260129669;
		goto LABEL_18;
	case 0xBu:
		hdmi_writel(0x1002Cu, 0x3DDC5040u);
		hdmi_writel(0x10030u, 0x8008430A);
		hdmi_mdelay(0xAu);
		hdmi_writel(0x10034u, 1u);
		v22 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v22 | 0x2000000);
		hdmi_mdelay(0x64u);
		v23 = hdmi_readl(0x10038u);
		v24 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, v24 | 0xC0000000);
		v25 = hdmi_readl(0x1002Cu);
		hdmi_writel(0x1002Cu, ((v23 >> 11) & 0x3F) | v25);
		hdmi_writel(0x10020u, 0x11FFFF7Fu);
		hdmi_writel(0x10024u, tmp_rcal_200 | 0x80623000);
		v13 = 260096645;
		LABEL_18: hdmi_writel(0x10028u, v13);
		bsp_hdmi_inner_init();
		hdmi_write(0x840u, 1u);
		v26 = & ptbl [v4];
		hdmi_write(0x4845u, 0);
		v27 = v26->para [3];
		hdmi_write(0x40u, v27 | 0x10);
		if (v27 > 0x5F)
			v28 = 0;
		else
			v28 = 3;
		hdmi_write(0x10001u, v28);
		hdmi_write(0x8040u, v26->para [4]);
		hdmi_write(0x4043u, v26->para [5]);
		hdmi_write(0x8042u, v26->para [6]);
		hdmi_write(0x42u, v26->para [7]);
		hdmi_write(0x4042u, v26->para [8]);
		hdmi_write(0x4041u, v26->para [9]);
		hdmi_write(0xC041u, v26->para [10]);
		hdmi_write(0x41u, v26->para [11]);
		hdmi_write(0x8041u, v26->para [12]);
		hdmi_write(0x4040u, v26->para [13]);
		hdmi_write(0xC040u, v26->para [14]);
		hdmi_write(0x43u, v26->para [15]);
		hdmi_write(0x8043u, v26->para [16]);
		hdmi_write(0x45u, 0xCu);
		hdmi_write(0x8044u, 0x20u);
		hdmi_write(0x8045u, 1u);
		hdmi_write(0x46u, 0xBu);
		hdmi_write(0x47u, 0x16u);
		hdmi_write(0x8046u, 0x21u);
		v29 = v26->para [2];
		if (v29)
			v30 = 33;
		else
			v30 = 16;
		hdmi_write(0x3048u, v30);
		v31 = v29;
		if (v29)
			v31 = 1;
		hdmi_write(0x401u, v31);
		hdmi_write(0x8400u, 7u);
		hdmi_write(0x8401u, 0);
		hdmi_write(0x402u, 0x47u);
		hdmi_write(0x800u, 1u);
		hdmi_write(0x801u, 7u);
		hdmi_write(0x8800u, 0);
		hdmi_write(0x8801u, 0);
		hdmi_write(0x802u, 0);
		hdmi_write(0x803u, 0);
		hdmi_write(0x8802u, 0);
		hdmi_write(0x8803u, 0);
		if (video_is_hdmi)
		{
			hdmi_write(0xB045u, 8u);
			hdmi_write(0x2045u, 0);
			hdmi_write(0x2044u, 0xCu);
			hdmi_write(0x6041u, 3u);
			v32 = ptbl [v4].para [0];
			if ((v32 & 0x100) != 0)
			{
				v33 = 32;
			}
			else if ((v32 & 0x80) != 0)
			{
				v33 = 64;
			}
			else
			{
				v33 = 0;
			}
			hdmi_write(0xA044u, v33);
			if ((v32 & 0x100) != 0)
				v34 = v32 & 0x7F;
			else
				v34 = 0;
			hdmi_write(0xA045u, v34);
			hdmi_write(0x2046u, 0);
			hdmi_write(0x3046u, 1u);
			hdmi_write(0x3047u, 0x11u);
			hdmi_write(0x4044u, 0);
			hdmi_write(0x52u, 0);
			hdmi_write(0x8051u, 0x11u);
			hdmi_read(0);
			hdmi_write(0x10010u, 0x45u);
			hdmi_write(0x10011u, 0x45u);
			hdmi_write(0x10012u, 0x52u);
			hdmi_write(0x10013u, 0x54u);
			v35 = hdmi_read(0x40u);
			hdmi_write(0x40u, v35 | 8);
			hdmi_read(0);
			hdmi_write(0x10010u, 0x52u);
			hdmi_write(0x10011u, 0x54u);
			hdmi_write(0x10012u, 0x41u);
			hdmi_write(0x10013u, 0x57u);
			if (video_is_yuv)
				v36 = 2;
			else
				v36 = 0;
			hdmi_write(0x4045u, v36);
			csc = video_csc;
			v38 = ptbl [v4].para [17];
			if (v38)
			{
				v40 = (uint8_t) csc << 6;
				if (v38 == 1)
					v41 = v40 | 0x28;
				else
					v41 = v40 | 8;
				if (v38 == 1)
					v39 = v41 & 0xE8;
				else
					v39 = v41 & 0xC8;
			}
			else
			{
				v39 = ((uint8_t) csc << 6) | 0x18;
			}
			hdmi_write(0xC044u, v39);
			if (video_is_yuv)
				v42 = 0;
			else
				v42 = 4;
			hdmi_write(0xC045u, v42);
			v43 = ptbl [v4].para [0];
			if ((v43 & 0x100) != 0)
				v44 = 0;
			else
				v44 = v43 & 0x7F;
			hdmi_write(0x4046u, v44);
		}
		if (video_is_hcts)
		{
			if (video_is_hdmi)
				v45 = - 111;
			else
				v45 = - 112;
			hdmi_write(0xC0u, v45);
			hdmi_write(0xC1u, 5u);
			if (ptbl [v4].para [3] <= 0x5F)
				v46 = 16;
			else
				v46 = 26;
			hdmi_write(0x40C1u, v46);
			hdmi_write(0x80C2u, 0xFFu);
			hdmi_write(0x40C0u, 0xFDu);
			hdmi_write(0xC0C0u, 0x40u);
			hdmi_write(0xC1u, 4u);
			hdmi_read(0);
			hdmi_write(0x10010u, 0x45u);
			hdmi_write(0x10011u, 0x45u);
			hdmi_write(0x10012u, 0x52u);
			hdmi_write(0x10013u, 0x54u);
			v47 = hdmi_read(0x40u);
			hdmi_write(0x40u, ~ ((unsigned int) ~ (v47 << 25) >> 25));
			if (video_is_hdmi)
				v48 = - 107;
			else
				v48 = - 108;
			hdmi_write(0xC0u, v48);
			hdmi_read(0);
			hdmi_write(0x10010u, 0x52u);
			hdmi_write(0x10011u, 0x54u);
			hdmi_write(0x10012u, 0x41u);
			hdmi_write(0x10013u, 0x57u);
		}
		hdmi_write(0x82u, 0);
		hdmi_write(0x81u, 0);
		hdmi_write(0x840u, 0);
		result = 0;
		break;
	default:
		result = - 1;
		break;
	}
	return result;
}
// 658: control flows out of bounds to 65C

#if 0
//----- (00000F08) --------------------------------------------------------
int bsp_hdmi_audio(unsigned int vic)
{
	unsigned int vid; // r0
	uint8_t v3; // r1
	unsigned int v4; // r5
	int v5; // r3
	int v6; // r2
	unsigned int sample_bit; // r1
	uint8_t v8; // r1
	int v9; // r3
	char *v10; // r3
	int v11; // r5
	unsigned int ch_num; // r1
	unsigned int v13; // r0
	uint8_t v14; // r1

	vid = get_vid(vic);
	if (audio_ch_num > 2)
		v3 = - 15;
	else
		v3 = - 16;
	v4 = vid;
	hdmi_write(0xA049u, v3);
	v5 = 0;
	while (ca_table [v5] != audio_ca)
	{
		v5 += 2;
		if (v5 == 64)
			goto LABEL_8;
	}
	hdmi_write(0x204Bu, ~ * ((volatile uint8_t*) ptbl [19].para + v5 + 1));
	LABEL_8: hdmi_write(0xA04Au, 0);
	hdmi_write(0xA04Bu, 0x30u);
	hdmi_write(0x6048u, 0);
	hdmi_write(0x6049u, 1u);
	hdmi_write(0xE048u, 0x42u);
	hdmi_write(0xE049u, 0x86u);
	hdmi_write(0x604Au, 0x31u);
	hdmi_write(0x604Bu, 0x75u);
	hdmi_write(0xE04Au, 1u);
	v6 = 0;
	while (audio_sample_rate != sf [v6].sf)
	{
		if (++ v6 == 10)
			goto LABEL_12;
	}
	hdmi_write(0xE04Au, ptbl [19].para [2 * v6 + 17]);
	LABEL_12: sample_bit = audio_sample_bit;
	if (sample_bit == 16)
	{
		v8 = 2;
	}
	else if (sample_bit == 24)
	{
		v8 = 11;
	}
	else
	{
		v8 = 0;
	}
	hdmi_write(0xE04Bu, v8);
	hdmi_write(0x251u, audio_sample_bit);
	v9 = 0;
	while (audio_sample_rate != n_table [v9])
	{
		v9 += 3;
		if (v9 == 21)
		{
			v11 = 6272;
			goto LABEL_24;
		}
	}
	v10 = (char*) ptbl + 4 * v9;
	if (ptbl [v4].para [1] == 1)
		v11 = * ((volatile uint32_t *) v10 + 398);
	else
		v11 = * ((volatile uint32_t *) v10 + 399);
	LABEL_24:
	hdmi_write(0xA40u, v11);
	hdmi_write(0xA41u, BYTE1(v11));
	hdmi_write(0x8A40u, BYTE2(v11));
	hdmi_write(0xA43u, 0);
	hdmi_write(0x8A42u, 4u);
	hdmi_write(0xA049u, audio_ch_num > 2);
	if (audio_type == PCM)
		ch_num = audio_ch_num;
	else
		LOBYTE (ch_num) = 0;
	if (audio_type == PCM)
		LOBYTE (ch_num) = 16 * (ch_num - 1);
	hdmi_write(0x2043u, ch_num);
	hdmi_write(0xA042u, 0);
	hdmi_write(0xA043u, audio_ca);
	hdmi_write(0x6040u, 0);
	if (audio_type == PCM)
	{
		v13 = 33361;
	}
	else
	{
		if ((unsigned int) (audio_type - 11) > 1)
			v14 = 2;
		else
			v14 = 3;
		hdmi_write(0x8251u, v14);
		hdmi_write(0x251u, 0x15u);
		v13 = 41027;
	}
	hdmi_write(v13, 0);
	hdmi_write(0x250u, 0);
	hdmi_write(0x81u, 8u);
	hdmi_write(0x8080u, 0xF7u);
	hdmi_udelay(0x64u);
	hdmi_write(0x250u, 0xAFu);
	hdmi_udelay(0x64u);
	hdmi_write(0x81u, 0);
	return 0;
}
#endif

//----- (000011E4) --------------------------------------------------------
int bsp_hdmi_ddc_read(char cmd, char pointer, char offset, int nbyte, char *pbuf)
{
	int v9; // r7
	int v10; // r7
	int v11; // r10
	uint8_t v12; // r0
	uint8_t v13; // r0

	hdmi_read(0);
	v9 = 50;
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	hdmi_write(0x4EE1u, 0);
	do
	{
		if ((hdmi_read(0x4EE1u) & 1) != 0)
			break;
		hdmi_udelay(0xAu);
		-- v9;
	} while (v9);
	hdmi_write(0x8EE3u, 5u);
	v10 = 0;
	hdmi_write(0xEE3u, 8u);
	hdmi_write(0x4EE2u, 0xD8u);
	hdmi_write(0xCEE2u, 0xFEu);
	while (nbyte > 0)
	{
		hdmi_write(0xEE0u, 0x50u);
		v11 = 10;
		hdmi_write(0xEE1u, offset);
		hdmi_write(0x4EE0u, 0x30u);
		hdmi_write(0xCEE0u, pointer);
		hdmi_write(0xEE2u, 2u);
		while (-- v11)
		{
			if ((hdmi_read(0x13u) & 2) != 0)
			{
				v12 = hdmi_read(0x13u);
				hdmi_write(0x13u, v12 & 2);
				* pbuf ++ = hdmi_read(0x8EE1u);
				break;
			}
			if ((hdmi_read(0x13u) & 1) != 0)
			{
				v10 = - 1;
				v13 = hdmi_read(0x13u);
				hdmi_write(0x13u, v13 & 1);
				break;
			}
			hdmi_udelay(0x3E8u);
		}
		-- nbyte;
		++ offset;
	}
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	return v10;
}

//----- (000013B4) --------------------------------------------------------
int bsp_hdmi_get_hpd()
{
	unsigned int v0; // r4

	hdmi_read(0);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	v0 = hdmi_readl(0x10038u);
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	return (v0 >> 19) & 1;
}

//----- (00001450) --------------------------------------------------------
void bsp_hdmi_standby()
{
	hdmi_write(0x10020u, 7u);
	hdmi_write(0x1002Cu, 0);
}

//----- (00001478) --------------------------------------------------------
void bsp_hdmi_hrst()
{
	hdmi_write(0xC1u, 4u);
	hdmi_write(0x81u, 0x40u);
}

//----- (0000149C) --------------------------------------------------------
int bsp_hdmi_hdcp_err_check()
{
	int v0; // r4
	uint8_t v1; // r0

	hdmi_read(0);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	if ((hdmi_read(0x80C0u) & 0xFE) == 64)
	{
		v0 = 0;
	}
	else
	{
		v0 = - 1;
		v1 = hdmi_read(0xC1u);
		hdmi_write(0xC1u, v1 & 0xFE);
	}
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	return v0;
}

//----- (00001558) --------------------------------------------------------
int bsp_hdmi_cec_get_simple_msg(uint8_t *msg)
{
	int v2; // r4

	hdmi_write(0x1003Cu, 4u);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	hdmi_write(0x6F3u, 0xFFu);
	hdmi_write(0x86F2u, 0xFFu);
	hdmi_read(0);
	if ((hdmi_read(0x26F4u) & 1) != 0)
	{
		* msg = hdmi_read(0x26F1u);
		hdmi_write(0x26F4u, 0);
		v2 = 0;
	}
	else
	{
		v2 = - 1;
	}
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	return v2;
}

//----- (00001640) --------------------------------------------------------
int bsp_hdmi_cec_send(char *buf, uint8_t bytes)
{
	unsigned int v2; // r5
	int v5; // r4
	int v6; // r0
	uint8_t v7; // r1
	uint8_t v8; // r0

	v2 = bytes;
	if (! bytes)
		return - 1;
	if (bytes > 0x10u)
		return - 1;
	v5 = 0;
	hdmi_read(0);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	hdmi_read(0);
	hdmi_write(0x86F3u, v2);
	hdmi_read(0);
	hdmi_writel(0x10014u, 0x42494E47u);
	hdmi_read(0);
	do
	{
		v6 = v5 + 32000;
		v7 = buf [v5 ++];
		hdmi_write(v6 + 16, v7);
	} while ((uint8_t) v5 < v2);
	hdmi_read(0);
	hdmi_writel(0x10014u, 0);
	hdmi_read(0);
	hdmi_udelay(0x14u);
	v8 = hdmi_read(0x6F0u);
	hdmi_write(0x6F0u, v8 | 1);
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	hdmi_read(0);
	return 0;
}

//----- (0000178C) --------------------------------------------------------
void bsp_hdmi_cec_free_time_set(uint8_t value)
{
	uint8_t v2; // r0

	hdmi_read(0);
	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	hdmi_read(0);
	v2 = hdmi_read(0x6F0u);
	hdmi_write(0x6F0u, (v2 & 0xF9) | (2 * value));
	hdmi_read(0);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	hdmi_read(0);
}

//----- (00001844) --------------------------------------------------------
int bsp_hdmi_cec_sta_check()
{
	uint8_t v0; // r4

	hdmi_write(0x10010u, 0x45u);
	hdmi_write(0x10011u, 0x45u);
	hdmi_write(0x10012u, 0x52u);
	hdmi_write(0x10013u, 0x54u);
	v0 = hdmi_read(0x8012u);
	hdmi_write(0x10010u, 0x52u);
	hdmi_write(0x10011u, 0x54u);
	hdmi_write(0x10012u, 0x41u);
	hdmi_write(0x10013u, 0x57u);
	if ((v0 & 1) != 0)
		return 0;
	else
		return - 1;
}

// nfuncs=27 queued=26 decompiled=26 lumina nreq=0 worse=0 better=0
// ALL OK, 26 function(s) have been successfully decompiled

void t507_hdmi_phy_init(uint_fast32_t dotclock)
{
	unsigned int vic = 16;
	bsp_hdmi_init();
	bsp_hdmi_video(vic);
}

#endif
